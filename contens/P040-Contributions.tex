\section{Our Contributions}

We will present the SHE problem as an optimal control one, where the optimization variable is the signal $u(\tau)$ defined in the entire interval $[0,\pi)$. 
%
In particular, we will describe how the Fourier coefficients of the function $u(\tau)$ can be seen as the final state of a system controlled by $u (\tau)$. Además este control deberá ser una función definida a trozos tal que $u(\tau):[0,\pi) \rightarrow \mathcal{U}$. 

Con el fin de aligerar la notación defeniremos control digital como:
\vspace{1em}
\begin{definition}[Digital control of $\mathcal{U}$]
    A control $u(\tau)$ is called digital if, for each time $\tau\geq 0$, it only takes values in the finite set of real number $\mathcal{U}$ except a finite set of values (switching angles).  
\end{definition}
%
Hence, the optimization is performed among all the possible functions that satisfy $|u(\tau)|<1 $ and can control the final state at the desired Fourier coefficients. 
%
Then we will show how to design a control problem so that the solution is a digital control of $\mathcal{U}$.



In this formulation, the SHE problem converts in a minimization problem with restrictions which can be solved by well-known techniques. 
%
Since the problem has several minimizers, we shall solve it employing global optimizers. 
%
Furthermore, since the choice of the waveform is arbitrary, we shall proceed in the same way for each possible waveform. 

A continuación enumeraremos nuestras aportaciones, y luego explicaremos cada una de ella en detalle en las siguientes subsecciones:
\begin{enumerate}
    \item Reformulación del Problema \ref{pb:SHEp} como un problema de control óptimo.
    \item Una función penalización en el problema de control óptimo de manera que podemos conseguir controles considerando el conjunto admisible $\mathcal{U}=\{-1,1\}$(\emph{bang-bang controls}).
    \item Una función de penalización en funcional de coste del problema de control óptimo de manera que podemos conseguir conjuntos $\mathcal{U}$ más generales.
    \item Condiciones suficientes de las funciones de penalización para obtener controles.
\end{enumerate}

\subsection{Reformulation of SHE problem as optimal control problem}
Teniendo en cuenta tenemos todos los elementos considerados en la definición del Problema \ref{pb:SHEp}, introducimos el siguiente sistema dinámico:
\begin{equation}\label{eq:CauchyReversed}
    \begin{cases}
        \displaystyle\dot{\bm{x}}(\tau) = -\frac 2\pi\bm{\mathcal{D}}(\tau)u(\tau),  & \tau \in [0,\pi)
        \\[6pt]
        \bm{x}(0) = \bm{x}_0
    \end{cases},
\end{equation}
Where $\bm{x}(t) \in \mathbb{R}^{N_a + N_b}$ and $\bm{\mathcal{D}}(\tau) \in  \mathbb{R}^{N_a + N_b}$ are:
\begin{align*}
	\bm{x}(\tau) = \begin{bmatrix} \bm{\alpha}(\tau) \\ \bm{\beta}(\tau) \end{bmatrix}, \quad
	\bm{\mathcal{D}}(\tau) = \begin{bmatrix} \bm{\mathcal{D}}^\alpha(\tau) \\ \bm{\mathcal{D}}^\beta(\tau) \end{bmatrix}     
\end{align*}
y donde:
\begin{align*}
	\bm{\mathcal{D}}^\alpha(\tau) = 
	\begin{bmatrix} 
		\cos(e_a^1\tau) \\ \cos(e_a^2\tau) \\ \vdots \\ \cos(e_a^{N_a}\tau) 
	\end{bmatrix},
	\quad \bm{\mathcal{D}}^\beta(\tau) = 
	\begin{bmatrix} 
		\sin(e_b^1\tau) \\ \sin(e_b^2\tau) \\ \vdots \\ \sin(e_b^{N_b}\tau) 
	\end{bmatrix} 
\end{align*}
with $\bm{\mathcal{D}}^\beta(\tau) \in \mathbb{R}^{N_a} $ and $ \bm{\mathcal{D}}^\beta(\tau) \in \mathbb{R}^{N_b}$, and where the set $\mathcal{E}_a$ and $\mathcal{E}_b$ are:
\begin{align*}
	\mathcal{E}_a = \{e_a^1,e_a^2,e_a^3,\dots,e_a^{N_a}\}, \quad \mathcal{E}_b = \{e_b^1,e_b^2,e_b^3,\dots,e_b^{N_b}\}    
\end{align*}
%
Dado este sistema podemos considerar el siguiente problema de control
\vspace{1em}
\begin{problem}\label{pb:SHEpControl}
    Let $\mathcal{U}$ be defined as in \eqref{eq:Udef} and let $\mathcal{E} _a $ and $\mathcal{E} _b $ be two sets of odd numbers with cardinalities $|\mathcal{E}_a| = N_a $ and $ |\mathcal{E} _b| = N_b$, respectively. Given the vectors $\bm{a}_T \in \mathbb{R}^{N_a}$ and $\bm{b}_T \in \mathbb{R}^{N_b} $, let us define $\bm{x}_0=[\bm{a}_T,\bm{b}_T]^\top \in \mathbb{R}^{N_a}\times\mathbb{R}^{N_b}$. We look for $u:\in [0,\pi)\to\mathcal{U}$ such that the solution of \eqref{eq:CauchyReversed} with initial datum $\bm{x}(0)=\bm{x}_0$ satisfies $\bm{x}(\pi)=0$.
\end{problem}
\vspace{1em}

\begin{theorem}\label{th:SHEasDyn}
    El control óptimo $u(\tau)$, solución del Problema \ref{pb:SHEpControl}, es el función constante a trozos que resuleve el Problema \ref{pb:SHEp}.   
    $\hfill \blacksquare$
\end{theorem}

Esta proposición es una consecuencia directa del teorema funamental del cálculo. En donde se ha considerado la formula integral de los coeficientes de Fourier \eqref{eq:an} en su forma diferencial, de manera que la integración desde $\tau = 0 $ hasta $\tau = \pi/2$ es equivalente a la evolución del sistema \eqref{eq:CauchyReversed} en el mismo intervalo temporal.

\begin{figure}[ht!] 
    \centering
    \includegraphics[scale=0.325]{img/fig02.eps}
    \caption{Evolución del sistema dinámico con los conjuntos $\mathcal{E}_a = \{1,2\}$ y $\mathcal{E}_b = \{1,2\}$ considerando el control $u(\tau)$ presentado en la Figura \ref{fig:exampleSHE}. Además mostramos las posiciones de los ángulos de conmutación $\bm{\phi}$.}
\end{figure}

Gracias a este resultado podemos plantearnos el problema de control óptimo asociado al Problema \ref{pb:SHEpControl}.


In what follows, for a given vector $\bm{v}\in\mathbb{R}^d$, we shall always denote by $\|\bm{v}\|$ the euclidean norm $\|\bm{v}\|_{\mathbb{R}^d}$.
\newline


\begin{problem}[OCP for SHE]\label{pb:OCP1}
Let $\mathcal U$ be defined as in \eqref{eq:Udef}. Given two sets of odd numbers $\mathcal {E}_a $ and $\mathcal {E}_b $ with cardinality $N_a$ and $N_b$, respectively, and given the target $\bm{x}_T\in \mathbb{R}^{N_a+N_b}$, we look for the function $u(\tau):[0,\pi)\to \mathcal U$ solution of the optimal control problem  
\begin{align*}
	&\min_{u \in \mathcal{U}}\;\frac 12 \|\bm{x}(\pi)\|^2
	\\
    &\notag \text{subject to: }\quad \begin{cases}
            \displaystyle \dot{\bm{x}}(\tau) = -\frac 2\pi\bm{\mathcal{D}}(\tau) u(\tau),  & \tau \in [0,\pi)\\[6pt]
            \bm{x}(0) = \bm{x}_0
    \end{cases}
    \end{align*}
\end{problem}
The solution of Problem \ref{pb:OCP1} may be quite complex to be obtained, due to the restriction on the admissible control values. 

In order to bypass this difficulty, following a standard optimal control approach, we can formulate an equivalent minimization problem in which, instead of looking for $u\in\mathcal U$, we simply require that $|u|<1$ and we introduce a penalization term to ensure that $u$ is digital control of $\mathcal{U}$.


%
This alternative optimal control problem, which can be solved more easily by employing standard tools, reads as follows:
\newline
\begin{problem}[Penalized OCP for SHE]\label{pb:OCP_penalizado}
Fix $\epsilon>0$. Given two sets of odd numbers $\mathcal E_a $ and $\mathcal E_b $ and the target $\bm{x}_T \in \mathbb {R}^{N_a + N_b}$, we look a digital control of $\mathcal{U}$ as the solution of:
\begin{align*}
	&\min_{|u|<1} \Bigg[\frac 12 \|\bm{x}(\pi) \|^2+ \epsilon \int_0^{\pi} \mathcal{L}(u(\tau)) d\tau \Bigg]  
\end{align*}
under the dynamics given by \eqref{eq:CauchyReversed}.
\end{problem}

In Problem \ref{pb:OCP_penalizado}, the penalization function $\mathcal L: \mathbb{R} \rightarrow \mathbb{R}$ will be chosen such that the optimal control $u^*$ only takes values in $\mathcal U$. Furthermore, the parameter $\epsilon$ should be small so that the solution minimizes the distance from the final state and the target.

En general, un función de penalización que nos de un control digital de $\mathcal{U}$ no es evidente de conseguir. Si consideramos las condiciones de optimilidad  del sistema (Principio del mínimo de Pontryagin) podemos obtener una función $\mathcal{H}_m(u)$ (la función Hamiltoniana) que carateriza el comportamiento de la solución del Problema \ref{pb:numOCP2}.
\vspace{1em}
\begin{definition}[Hamiltoniano]
    Dado el problema \ref{pb:OCP_penalizado} definimos una función $\mathcal{H}_m:[-1,1]\rightarrow \mathbb{R}$ tal que:
    \begin{gather}\label{Hm}
        \mathcal{H}_m(u) = \epsilon \mathcal{L}(u) - mu  |  \forall m \in \mathbb{R}
    \end{gather}
\end{definition}

De esta manera podemos decir que:
\vspace{1em}
\begin{proposition}\label{prop:Hamiltoniano}
    Considerando el Problema \ref{pb:OCP_penalizado} y su función Hamiltoniana $\mathcal{H}_m$. Si para todo $m \in \mathbb{R} - \mathcal{M}$ todos los mínimos de la función Hamiltoniana están en $\mathcal{U}$, entonces la solución del Problema \ref{pb:OCP_penalizado} es un control digital de $\mathcal{U}$. Donde $\mathcal{M}$ pueder ser el conjunto vacio o un conjunto de elementos finitos. $\hfill \blacksquare $
\end{proposition}

Gracias a la proposición \ref{prop:Hamiltoniano}. Podemos diseñar las funiones de penalización $\mathcal{L}$ de manera que la función Hamiltonina $\mathcal{H}_m$ solo tenga mínimos en $\mathcal{U}$. 
%Next we will study the optimality conditions of the problem, for a general $\mathcal L$, and then specify how $\mathcal L$ should be so that the optimal control $u^*$ only takes the allowed values in $\mathcal U$.


\subsection{SHE bi-nivel via OCP (Bang-Bang Control)} 

En esta Subsección consideraremos el caso donde el conjunto de controles admisibles es $\mathcal{U}=\{-1,1\}$. En la literatura de SHE, este tipo de soluciones son llamados como formas de onda bi-nivel, mientras que el la literatura de la teoría de control este es conocido como controles \emph{bang-bang}.
\vspace{1em}
\begin{theorem}\label{th:bang-bang}
    Dado el Problema \ref{pb:OCP_penalizado} con el conjunto admisible de control $ \ \mathcal{U} = \{-1,1\}$. Si la función $\mathcal{L}$ es concava en el intervalo $[-1,1]$ del Problema \ref{pb:OCP_penalizado}, entonces la solución de problema es un control digital del conjunto $\mathcal{U} =  \{-1,1\}$.
    $\hfill \blacksquare$
\end{theorem}

Si aceptamos la Proposición \ref{th:bang-bang} es evidente que  para obtener un control digital de $\mathcal{U}=\{-1,1\}$ los mímimos Hamiltoniano $\mathcal{H}_m$ para todo $m\in \mathbb{R}-\mathcal{M}$ deben encontrarse en los bordes del intervalo $[-1,1]$ de manera que es suficiente considerar una función concava en el interior de este intervalo. 

Ilustramos esta idea en la Figura \ref{fig:Bang-Bang-penalization}, de manera que en la primera columna presentamos tres funciones de penalización compatible con la Proposición \ref{th:bang-bang} ($\mathcal{L}(u) = u$, $\mathcal{L}(u) = -u$, $\mathcal{L}(u) = -u^2$ ). Además mostramos a la derecha de cada una de ellas mostramos el comportamiento del Hamiltoniano para distintos valores de $m$ en diferentes colores y para cada una de ellas marcamos el mímimo del mismo color. Podemos ver que los mínimos en cada caso siempre siempre esta en $\mathcal{U}= \{-1,1\}$.
\begin{figure} 
    \centering
    \includegraphics[scale=0.415]{img/fig03.eps}
    \caption{SHE bi-nivel.} \footnotesize En la primera columna mostramos tres tipos de penalización concavas compatibles con la Proposición \ref{th:bang-bang}. A la derecha de cada una de ellas mostramos el comportamiento del Hamiltoniano para cada distintos valores de $m$ (colores). 
    \footnotesize

    \label{fig:Bang-Bang-penalization}
\end{figure}
\subsection{SHE multi-nivel via Piecewise linear penalization}

Gracias al caso bi-nivel podemos notar que si definimos una función de penalización $\mathcal{L}$ que entre dos valores $u_1$ y $u_2$ no tenga mímimos, es decir sea concava entre esos dos puntos entonces la función Hamiltoniana no tendrá el mímimos en $u \in (u_1,u_2)$ más que para un valor de concreto de $m$. Gracias a esta observación podemos afirmar que:

\vspace{1em}
\begin{theorem}\label{th:PLP}
    Given a set $\mathcal{U}$, we can choose the affine interpolation of a parabola $\mathcal{L}^{p_!}:[-1,1] \rightarrow \mathbb{R}$ as a penalization term. That is
    \begin{gather}\label{eq:PLP}
        \mathcal{L}^{p_1}(u) = \begin{cases}
            \lambda_k^{p_1}(u) & \text{if }  u \in [u_k,u_{k+1}[ \\
            1 & \text{if } u = u_{N_u} 
        \end{cases} \\
        \notag \forall k \in \{1,\dots,N_u-1\} 
    \end{gather}
    Donde 
    \begin{gather}
        \lambda_k^{p_1}(u) = (u_{k+1}+u_{k}) (u-u_k) + u_k^2
    \end{gather}
    De modo que el problema de \ref{pb:OCP_penalizado} con la penalización $\mathcal{L}(u)$ presentada antes tiene como solución un control digital del conjunto $\mathcal{U}$
    $\hfill \blacksquare$ 
\end{theorem}
\vspace{1em}
\begin{remark}[\emph{Bang-off-bang}]
    En este caso, podemos notar que cuando consideramos un conjunto de controles admisibles como $\mathcal{U}= \{-1,0,1\}$ recuperamos la penalización de norma $L^1$. Este tipo de penalización añadido a la restricción $|u|<1$ nos da controles \emph{bang-off-bang}, bien conocidos en la literatura de control \textcolor{red}{añadir referencias}.
\end{remark}

De la misma forma que en caso anterior en la Figura \ref{fig:SHE-multi} ilustramos como la penalización \eqref{eq:PLP} logra cumplir las condiciones de la proposición \ref{prop:Hamiltoniano}. Y por tanto esta penalización da lugar a una control óptimo digital de $\mathcal{U}$. 


\subsection{General conditions for  SHE multi-nivel}   

Como podemos observar el caso anterior no es más que una caso concrerto de condiciones más generales. De manera que podemos afirmar que: 
\vspace{1em}
\begin{theorem}\label{th:GeneralP}
    Assume that the finite set $\mathcal{U}$ defined in \eqref{eq:Udef} is composed by elements in ascending order. Let $\mathcal{Y} = \{y_\ell\}_{\ell=1}^L$ be another finite set, with the same cardinality as $\mathcal U$, such that the $L-1$ tuple
    \begin{gather}
        \frac{\Delta \mathcal{Y}}{\Delta \mathcal{U}} = \Bigg( \frac{y_\ell - y_{\ell+1}}{u_\ell - u_{\ell+1}} \Bigg)_{\ell=1}^{L-1}
    \end{gather}  is monotone. Let $\mathcal{L}:\mathbb{R} \rightarrow \mathbb{R}$ be a piece-wise continuous function:
    \begin{gather}
        \mathcal{L}(u) = \begin{cases}
            \lambda_k(u) & \text{if }  u \in [u_k,u_{k+1}[ \\
            1 & \text{if } u = u_{N_u} 
        \end{cases} \\
        \notag \forall k \in \{1,\dots,N_u-1\}
    \end{gather}    
    tal que $\{y_l = \mathcal{L}(u_l)\}_{l=1}^L$. 
    
    Entonces, si las funciones $\lambda_k$ para todo $k \in  \{1,\dots,N_u-1\}$  son funciones concavas, entonces la penalización $\mathcal{L}$ en el problema \ref{pb:OCP_penalizado} da lugar a un control digital de $\mathcal{U}$.
    $\hfill \blacksquare$
\end{theorem}

En la Figura \ref{fig:SHE-multi} se presenta otras dos funciones  compatibles con el Teorema \ref{th:GeneralP}. Estos son:

\begin{enumerate}
    \item Aproximación de una parabola desplazada:
    \begin{gather}
        \lambda_k^{p_2}(u) = -4u^2 + 2(u_k + u_{k+1}) - 2u_{k}
    \end{gather}
    \item Unión de funciones concavas:
    \begin{gather}
        \lambda_k^{p_3}(u) = \frac 1 4[(u_{k+1}+u_{k}) (u-u_k-1) + u_k^2]
    \end{gather}
\end{enumerate}

Al igual que en la Figura \ref{fig:Bang-Bang-penalization}, en la Figura \ref{fig:SHE-multi} se muestra en la primera columna las posibles funciones de penalización. A la derecha de cada una de ellas se muestra el comportamiento del Hamiltoniano asociada a cada una de ellas. Se puede ver como los mimimos para todos los casos, solo toma los valores $\mathcal{U} = \{-1,-1/2,0,1/2,1\}$.
\begin{figure}
    \includegraphics[scale=0.415]{img/fig04.eps}
    \caption{SHE Multi-nivel.} \footnotesize En la primera columna mostramos tres tipos de penalización concavas compatibles con la Proposición \ref{th:bang-bang}. A la derecha de cada una de ellas mostramos el comportamiento del Hamiltoniano para cada distintos valores de $m$ (colores). 
    \label{fig:SHE-multi}
\end{figure} 